using System.Text;

namespace Rftim3CodinGame.Refactor.Puzzles
{
    public class MCxxxxMicrocontroller
    {
        public MCxxxxMicrocontroller()
        {
            //List<int> inputData = new()
            //{
            //    2
            //};
            //int n = 1;
            //List<string> lineOfCode = new()
            //{
            //    "mov x0 x1"
            //};

            //int k = 2;
            //List<int> inputData = new()
            //{
            //    1,
            //    2
            //};
            //int n = 2;
            //List<string> lineOfCode = new()
            //{
            //    "mov x0 x1",
            //    "mov x0 x1"
            //};

            //List<int> inputData = new()
            //{
            //    1,
            //    2
            //};
            //int n = 4;
            //List<string> lineOfCode = new()
            //{
            //    "mov x0 dat",
            //    "mov x0 x1",
            //    "mov dat acc",
            //    "mov acc x1"
            //};

            //List<int> inputData = new()
            //{
            //    3
            //};
            //int n = 7;
            //List<string> lineOfCode = new()
            //{
            //    "mov x0 dat",
            //    "mov 4 acc",
            //    "add dat",
            //    "mov acc x1",
            //    "mov 4 acc",
            //    "sub dat",
            //    "mov acc x1"
            //};

            //public MCxxxx_Microcontroller()
            //{
            //    Solve(k, inputData, n, lineOfCode);
            //}

            //private readonly int k = 2;
            //private readonly List<int> inputData = new()
            //{
            //    5,
            //    7
            //};
            //private readonly int n = 4;
            //private readonly List<string> lineOfCode = new()
            //{
            //    "mov x0 acc",
            //    "mov x0 dat",
            //    "mul dat",
            //    "mov acc x1"
            //};

            //private readonly int k = 4;
            //private readonly List<int> inputData = new()
            //{
            //    0,
            //    56,
            //    -3,
            //    100
            //};
            //private readonly int n = 12;
            //private readonly List<string> lineOfCode = new()
            //{
            //    "mov x0 acc",
            //    "not",
            //    "mov acc x1",
            //    "mov x0 acc",
            //    "not",
            //    "mov acc x1",
            //    "mov x0 acc",
            //    "not",
            //    "mov acc x1",
            //    "mov x0 acc",
            //    "not",
            //    "mov acc x1"
            //};

            //private readonly int k = 1;
            //private readonly List<int> inputData = new()
            //{
            //    2
            //};
            //private readonly int n = 11;
            //private readonly List<string> lineOfCode = new()
            //{
            //    "mov x0 dat",
            //    "mov dat acc",
            //    "# mov dat x1",
            //    "jmp end",
            //    "mov dat x1",
            //    "mult:",
            //    "mul dat",
            //    "jmp ending",
            //    "end: jmp mult",
            //    "ending:",
            //    "mov acc x1"
            //};

            //private readonly int k = 1;
            //private readonly List<int> inputData = new()
            //{
            //    2
            //};
            //private readonly int n = 7;
            //private readonly List<string> lineOfCode = new()
            //{
            //    "mov x0 acc",
            //    "calc:",
            //    @"# /╲/\( •̀ ω •́ )/\╱\",
            //    "# Look at my spider, it's so cute!",
            //    "sub 1",
            //    "@ jmp calc",
            //    "mov acc x1"
            //};

            //private readonly int k = 1;
            //private readonly List<int> inputData = new()
            //{
            //    1
            //};
            //private readonly int n = 3;
            //private readonly List<string> lineOfCode = new()
            //{
            //    "mov x0 x1",
            //    "jmp end",
            //    "end:"
            //};

            //private readonly int k = 3;
            //private readonly List<int> inputData = new()
            //{
            //    -999,
            //    999,
            //    100
            //};
            //private readonly int n = 10;
            //private readonly List<string> lineOfCode = new()
            //{
            //    "mov x0 acc",
            //    "sub 50",
            //    "mov acc x1",
            //    "mov x0 acc",
            //    "add 50",
            //    "mov acc x1",
            //    "mov x0 dat",
            //    "mov dat acc",
            //    "mul dat",
            //    "mov acc x1"
            //};

            //private readonly int k = 1;
            //private readonly List<int> inputData = new()
            //{
            //    4
            //};
            //private readonly int n = 7;
            //private readonly List<string> lineOfCode = new()
            //{
            //    "mov x0 dat",
            //    "+ mov dat x1",
            //    "- mov dat x1",
            //    "teq dat 0",
            //    "+ add 1",
            //    "- sub 1",
            //    "mov acc x1"
            //};

            //private readonly int k = 1;
            //private readonly List<int> inputData = new()
            //{
            //    0
            //};
            //private readonly int n = 7;
            //private readonly List<string> lineOfCode = new()
            //{
            //    "mov x0 dat",
            //    "tgt dat -1",
            //    "+ mov 1 x1",
            //    "- mov -1 x1",
            //    "tlt dat 1",
            //    "+ mov 1 x1",
            //    "- mov -1 x1"
            //};

            //private readonly int k = 1;
            //private readonly List<int> inputData = new()
            //{
            //    0
            //};
            //private readonly int n = 10;
            //private readonly List<string> lineOfCode = new()
            //{
            //    "mov x0 dat",
            //    "tcp dat -1",
            //    "+ mov 1 x1",
            //    "- mov -1 x1",
            //    "tcp dat 0",
            //    "+ mov 1 x1",
            //    "- mov -1 x1",
            //    "tcp dat 1",
            //    "+ mov 1 x1",
            //    "- mov -1 x1"
            //};

            //private readonly int k = 2;
            //private readonly List<int> inputData = new()
            //{
            //    123,
            //    99
            //};
            //private readonly int n = 13;
            //private readonly List<string> lineOfCode = new()
            //{
            //    "mov x0 dat",
            //    "mov dat acc",
            //    "dgt 0",
            //    "mov acc x1",
            //    "mov dat acc",
            //    "dgt 1",
            //    "mov acc x1",
            //    "mov dat acc",
            //    "dgt 2",
            //    "mov acc x1",
            //    "mov x0 acc",
            //    "dgt 2",
            //    "mov acc x1"
            //};

            //private readonly int k = 3;
            //private readonly List<int> inputData = new()
            //{
            //    0,
            //    9,
            //    0
            //};
            //private readonly int n = 9;
            //private readonly List<string> lineOfCode = new()
            //{
            //    "mov x0 acc",
            //    "mov x0 dat",
            //    "dst acc dat",
            //    "dst 1 dat",
            //    "dst 2 dat",
            //    "mov acc x1",
            //    "mov x0 acc",
            //    "dst 2 dat",
            //    "mov acc x1"
            //};

            //private readonly int k = 2;
            List<int> inputData = new()
            {
                2,
                1
            };
            int n = 11;
            List<string> lineOfCode = new()
            {
                "# Print all power of 2 from 1 to 512",
                "mov x0 dat",
                "mov x0 acc",
                "# dat = 2, acc = 1",
                "loop:",
                "mov acc x1",
                "# print content of acc",
                "mul dat",
                "tlt acc 512",
                "+ jmp loop",
                "mov acc x1"
            };

            //private readonly int k = 1;
            //private readonly List<int> inputData = new()
            //{
            //    0
            //};
            //private readonly int n = 16;
            //private readonly List<string> lineOfCode = new()
            //{
            //    "# JUMP JUMP JUMP !!!",
            //    "jmp one",
            //    "two: mov 2 x1",
            //    "jmp three",
            //    "six: mov 6 x1",
            //    "jmp end",
            //    "four: mov 4 x1",
            //    "jmp five",
            //    "one: mov 1 x1",
            //    "jmp two",
            //    "three: mov 3 x1",
            //    "jmp four",
            //    "five: mov 5 x1",
            //    "jmp six",
            //    "end: ",
            //    "#the end o(TヘTo)"
            //};

            //private readonly int k = 1;
            //private readonly List<int> inputData = new()
            //{
            //    7
            //};
            //private readonly int n = 9;
            //private readonly List<string> lineOfCode = new()
            //{
            //    "jmp test",
            //    "mov acc dat",
            //    "another_test:",
            //    "add 10",
            //    "jmp hello",
            //    "test:",
            //    "mov x0 acc",
            //    "jmp another_test",
            //    "hello: mov acc x1"
            //};

            //List<int> inputData = new()
            //{
            //    2,
            //    5
            //};
            //int n = 4;
            //List<string> lineOfCode = new()
            //{
            //    "mov x0 acc",
            //    "mov x0 x1",
            //    "mov acc dat",
            //    "mov dat x1"
            //};

            Solve(inputData, n, lineOfCode);

        }

        private static void Solve(List<int> inputData, int n, List<string> lineOfCode)
        {
            List<Register> registers = new()
            {
                new Register("acc", 0),
                new Register("dat", 0)
            };
            List<string> prefixes = new();

            int index = 0;
            bool branchActive = false;
            bool sign = false;

            StringBuilder sb = new();
            for (int i = 0; i < n; i++)
            {
                index = 0;
                bool jump = false;


                if (lineOfCode[i][..1] != "#")
                {
                    if (lineOfCode[i].Contains(' '))
                    {
                        int splitCount = lineOfCode[i].Split(' ').Length;

                        if (splitCount == 2)
                        {
                            string first = lineOfCode[i].Split(' ')[0];
                            string second = lineOfCode[i].Split(' ')[1];

                            if (first == "add")
                            {
                                if (int.TryParse(second, out int x))
                                {
                                    foreach (Register register in registers.Where(o => o.name == "acc"))
                                    {
                                        register.value += x;
                                        if (register.value > 999) register.value = 999;
                                    }
                                }
                                else
                                {
                                    switch ($"{second}")
                                    {
                                        case "dat":
                                            foreach (Register register in registers.Where(o => o.name == "acc"))
                                            {
                                                foreach (Register register1 in registers.Where(o => o.name == "dat"))
                                                {
                                                    register.value += register1.value;
                                                    if (register.value > 999) register.value = 999;
                                                }
                                            }
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                            else if (first == "sub")
                            {
                                if (int.TryParse(second, out int x))
                                {
                                    foreach (Register register in registers.Where(o => o.name == "acc"))
                                    {
                                        register.value -= x;
                                        if (register.value < -999) register.value = -999;
                                    }
                                }
                                else
                                {
                                    switch ($"{second}")
                                    {
                                        case "dat":
                                            foreach (Register register in registers.Where(o => o.name == "acc"))
                                            {
                                                foreach (Register register1 in registers.Where(o => o.name == "dat")) register.value -= register1.value;
                                            }
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                            else if (first == "mul")
                            {
                                switch ($"{second}")
                                {
                                    case "dat":
                                        foreach (Register register in registers.Where(o => o.name == "acc"))
                                        {
                                            foreach (Register register1 in registers.Where(o => o.name == "dat"))
                                            {
                                                if (register.value == 0) register.value = register1.value;
                                                else register.value *= register1.value;
                                                if (register.value > 999) register.value = 999;
                                            }
                                        }
                                        break;
                                    default:
                                        break;
                                }
                            }
                            else if (first == "jmp")
                            {
                                foreach (string code in lineOfCode)
                                {
                                    if (code.Contains($"{second}:"))
                                    {
                                        index = lineOfCode.IndexOf(code) - 1;
                                        jump = true;
                                    }
                                }
                            }
                            else if (first == "dgt")
                            {
                                foreach (Register register in registers.Where(o => o.name == "acc"))
                                {
                                    string temp = register.value.ToString();
                                    if (temp.Length > int.Parse(second)) register.value = int.Parse(temp.Substring(temp.Length - 1 - int.Parse(second), 1));
                                    else register.value = 0;
                                }
                            }
                        }

                        if (splitCount == 3)
                        {
                            string first = lineOfCode[i].Split(' ')[0];
                            string second = lineOfCode[i].Split(' ')[1];
                            string third = lineOfCode[i].Split(' ')[2];

                            if (first == "mov")
                            {
                                if (int.TryParse(second, out int x))
                                {
                                    switch ($"{third}")
                                    {
                                        case "acc":
                                            foreach (Register register in registers.Where(o => o.name == "acc")) register.value = x;
                                            break;
                                        default:
                                            break;
                                    }
                                }
                                else
                                {
                                    switch ($"{second} {third}")
                                    {
                                        case "x0 x1":
                                            sb.Append($"{inputData[0]} ");
                                            inputData.RemoveAt(0);
                                            break;
                                        case "x0 acc":
                                            foreach (Register register in registers.Where(o => o.name == "acc"))
                                            {
                                                register.value = inputData[0];
                                                inputData.RemoveAt(0);
                                            }
                                            break;
                                        case "x0 dat":
                                            foreach (Register register in registers.Where(o => o.name == "dat"))
                                            {
                                                register.value = inputData[0];
                                                inputData.RemoveAt(0);
                                            }
                                            break;
                                        case "dat acc":
                                            foreach (Register register in registers.Where(o => o.name == "acc"))
                                            {
                                                foreach (Register register1 in registers.Where(o => o.name == "dat")) register.value = register1.value;
                                            }
                                            break;
                                        case "acc dat":
                                            foreach (Register register in registers.Where(o => o.name == "dat"))
                                            {
                                                foreach (Register register1 in registers.Where(o => o.name == "acc")) register.value = register1.value;
                                            }
                                            break;
                                        case "dat x1":
                                            foreach (Register register in registers.Where(o => o.name == "dat")) sb.Append($"{register.value} ");
                                            break;
                                        case "acc x1":
                                            foreach (Register register in registers.Where(o => o.name == "acc")) sb.Append($"{register.value} ");
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                            else if (first.Contains(':'))
                            {
                                if (second == "jmp")
                                {
                                    foreach (string code in lineOfCode)
                                    {
                                        if (code.Contains($"{third}:"))
                                        {
                                            index = lineOfCode.IndexOf(code);
                                            jump = true;
                                        }
                                    }
                                }
                            }
                            else if (first == "@")
                            {
                                if (!prefixes.Contains($"@{i}"))
                                {
                                    prefixes.Add($"@{i}");
                                    if (second == "jmp")
                                    {
                                        foreach (string code in lineOfCode)
                                        {
                                            if (code.Contains($"{third}:"))
                                            {
                                                index = lineOfCode.IndexOf(code) - 1;
                                                jump = true;
                                            }
                                        }
                                    }
                                }
                            }
                            else if (first == "teq")
                            {
                                branchActive = true;

                                foreach (Register register in registers.Where(o => o.name == "dat"))
                                {
                                    sign = register.value == int.Parse(third);
                                }
                            }
                            else if (first == "tgt")
                            {
                                branchActive = true;

                                foreach (Register register in registers.Where(o => o.name == "dat"))
                                {
                                    sign = register.value > int.Parse(third);
                                }
                            }
                            else if (first == "tlt")
                            {
                                branchActive = true;
                                if (second == "acc")
                                {
                                    foreach (Register register in registers.Where(o => o.name == "acc"))
                                    {
                                        sign = register.value < int.Parse(third);
                                    }
                                }
                                else if (second == "dat")
                                {
                                    foreach (Register register in registers.Where(o => o.name == "dat"))
                                    {
                                        sign = register.value < int.Parse(third);
                                    }
                                }
                            }
                            else if (first == "tcp")
                            {
                                branchActive = true;

                                foreach (Register register in registers.Where(o => o.name == "dat"))
                                {
                                    if (int.TryParse(third, out int x))
                                    {
                                        if (register.value == x) branchActive = false;
                                        else if (register.value > x) sign = true;
                                        else if (register.value < x) sign = false;
                                    }
                                }
                            }
                            else if (first == "+" && branchActive && sign)
                            {
                                switch ($"{second}")
                                {
                                    case "add":
                                        foreach (Register register in registers.Where(o => o.name == "acc"))
                                        {
                                            register.value += int.Parse(third);
                                        }
                                        break;
                                    case "jmp":
                                        foreach (string code in lineOfCode)
                                        {
                                            if (code.Contains($"{third}:"))
                                            {
                                                index = lineOfCode.IndexOf(code) - 1;
                                                jump = true;
                                            }
                                        }
                                        break;
                                    default:
                                        break;
                                }
                                branchActive = false;
                            }
                            else if (first == "-" && branchActive && !sign)
                            {
                                switch ($"{second}")
                                {
                                    case "sub":
                                        foreach (Register register in registers.Where(o => o.name == "acc"))
                                        {
                                            register.value -= int.Parse(third);
                                        }
                                        break;
                                    default:
                                        break;
                                }
                                branchActive = false;
                            }
                            else if (first == "dst")
                            {
                                if (int.TryParse(second, out int x))
                                {
                                    foreach (Register register in registers.Where(o => o.name == "acc"))
                                    {
                                        foreach (Register register1 in registers.Where(o => o.name == "dat"))
                                        {
                                            int nr1 = register.value.ToString().Length;
                                            string temp = register.value.ToString();

                                            if (nr1 > x) register.value = int.Parse($"{temp[..x]}{register1.value}{temp[(x + 1)..]}");
                                            else
                                            {
                                                if (nr1 == x) register.value = int.Parse($"{register1.value}{register.value}");
                                                else
                                                {
                                                    for (int j = 0; j < nr1; j++) temp = "0" + temp;
                                                    register.value = int.Parse(register1.value.ToString() + temp);
                                                }
                                            }
                                        }
                                    }
                                }
                                else
                                {
                                    foreach (Register register in registers.Where(o => o.name == "acc"))
                                    {
                                        foreach (Register register1 in registers.Where(o => o.name == "dat"))
                                        {
                                            int nr1 = register.value.ToString().Length;
                                            int nr2 = register.value;
                                            string temp = register.value.ToString();

                                            if (nr1 >= nr2) register.value = int.Parse($"{temp[..nr2]}{register1.value}{temp[(nr2 + 1)..]}");
                                        }
                                    }
                                }
                            }
                        }

                        if (splitCount == 4)
                        {
                            string first = lineOfCode[i].Split(' ')[0];
                            string second = lineOfCode[i].Split(' ')[1];
                            string third = lineOfCode[i].Split(' ')[2];
                            string fourth = lineOfCode[i].Split(' ')[3];

                            if (first == "+" && branchActive && sign)
                            {
                                if (second == "mov")
                                {
                                    if (int.TryParse(third, out int x))
                                    {
                                        switch ($"{fourth}")
                                        {
                                            case "x1":
                                                sb.Append($"{x} ");
                                                break;
                                            default:
                                                break;
                                        }
                                    }
                                    else
                                    {
                                        switch ($"{third} {fourth}")
                                        {
                                            case "dat x1":
                                                foreach (Register register in registers.Where(o => o.name == "dat"))
                                                {
                                                    sb.Append($"{register.value} ");
                                                }
                                                break;
                                            default:
                                                break;
                                        }
                                    }
                                }
                                branchActive = false;
                            }
                            else if (first == "-" && branchActive && !sign)
                            {
                                if (second == "mov")
                                {
                                    if (int.TryParse(third, out int x))
                                    {
                                        switch ($"{fourth}")
                                        {
                                            case "x1":
                                                sb.Append($"{x} ");
                                                break;
                                            default:
                                                break;
                                        }
                                    }
                                    else
                                    {
                                        switch ($"{third} {fourth}")
                                        {
                                            case "dat x1":
                                                foreach (Register register in registers.Where(o => o.name == "dat"))
                                                {
                                                    sb.Append($"{register.value} ");
                                                }
                                                break;
                                            default:
                                                break;
                                        }
                                    }
                                }
                                branchActive = false;
                            }
                            else if (first.Contains(':') && second == "mov")
                            {
                                if (fourth == "x1")
                                {
                                    if (int.TryParse(third, out int x))
                                    {
                                        sb.Append($"{x} ");
                                    }
                                    else
                                    {
                                        if (third == "acc")
                                        {
                                            foreach (Register register in registers.Where(o => o.name == "acc"))
                                            {
                                                sb.Append($"{register.value} ");
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        if (lineOfCode[i] == "not")
                        {
                            foreach (Register register in registers.Where(o => o.name == "acc"))
                            {
                                register.value = register.value == 0 ? 100 : 0;
                            }
                        }
                    }
                }

                if (jump) i = index;
            }

            Console.WriteLine($"{sb.ToString().TrimEnd()}");
        }

        class Register
        {
            public string name;
            public int value;

            public Register(string name, int value)
            {
                this.name = name;
                this.value = value;
            }
        }
    }
}
